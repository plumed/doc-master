<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<title>PLUMED: PYCVINTERFACE</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script>
   var redpath = "";
   
   function showPath(eg,name) {
     var i; var y = document.getElementsByName(redpath);
     for (i=0; i < y.length; i++ ) { y[i].style.color="black"; }
     var x = document.getElementsByName(name); redpath=name;
     for (i = 0; i < x.length; i++) { x[i].style.color="red"; }
     var valid="value_details_".concat(eg);
     var valueField = document.getElementById(valid);
     var dataField = document.getElementById(name);
     valueField.innerHTML = dataField.innerHTML;
   }
   function swapInput(name) {
     var btn = document.getElementById(name + "_button");
     var mydiv = document.getElementById("input_" + name);
     if( btn.textContent=="expand shortcuts" ) {
         btn.textContent = "contract shortcuts";
         var dataField = document.getElementById(name + "long");
         mydiv.innerHTML = dataField.innerHTML;
     } else if( btn.textContent=="contract shortcuts" ) {
         btn.textContent = "expand shortcuts";
         var dataField = document.getElementById(name + "short");
         mydiv.innerHTML = dataField.innerHTML;
     }
   }
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.11.0-dev</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_p_y_c_v_i_n_t_e_r_f_a_c_e.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">PYCVINTERFACE </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Define collective variables in the Python language.</p>
<p>Plumed will import the module chosen wiht the <code>IMPORT</code> keyword. The module can be a simple py file or a directory with the standard module configuration (a directory that contains at least an <b>init</b>.py, see the rt-persistentData test for an example).</p>
<p>In the module there must be a function that will be used in caclulation and the definition of the component(s) (meaning period and if derivatives will be returned) of your cv.</p>
<p>PYCVINTERFACE will call two or more elements from the module. Each element or function can be selected with its dedicated keyword:</p><ul>
<li><code>CALCULATE</code> will select the function to be called at each step (defaults to <code>"plumedCalculate"</code>)</li>
<li><code>INIT</code> will select the function (or the dict, see down) to be called during the initilization (defaults to <code>"plumedInit"</code>)</li>
<li><code>UPDATE</code> will select the function to be called at each step, during the update() invocation</li>
<li><code>PREPARE</code> will select the function to be called at each step, during the prepare() invocation All the function called will need a single argument of type <code>plumedCommunications.PythonCVInterface</code></li>
</ul>
<dl class="section user"><dt>Getting started</dt><dd></dd></dl>
<p>The minimal plumed input is: </p>
<div style="width: 90%; float:left" id="value_details_eg1"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/master-failed-red.svg" alt="tested on master" /></div><pre style="width: 97%;" class="fragment">
<b name="eg1cv1" onclick='showPath("eg1","eg1cv1")'>cv1: </b><a href="https://www.plumed.org/doc-master/user-doc/html/_p_y_t_h_o_n_c_v.html" style="color:green">PYTHONCV</a> <div class="tooltip">IMPORT<div class="right"><b> could not find this keyword </b><i></i></div></div>=hello <div class="tooltip">ATOMS<div class="right"><b> could not find this keyword </b><i></i></div></div>=1 <span style="display:none;" id="eg1cv1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-master/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=colvar.out <div class="tooltip">ARG<div class="right"><b>compulsory keyword </b>
the labels of the values that you would like to print to the file <i></i></div></div>=* <span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>this should be paired with the <code>hello.py</code> file: </p><div class="fragment"><div class="line"><span class="keyword">import</span> plumedCommunications <span class="keyword">as</span> PLMD</div>
<div class="line"> </div>
<div class="line">plumedInit={<span class="stringliteral">&quot;Value&quot;</span>:PLMD.defaults.COMPONENT_NODEV}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>plumedCompute(action: PLMD.PythonCVInterface):</div>
<div class="line">    action.log(<span class="stringliteral">&quot;Hello, world, from calculate!&quot;</span>)</div>
<div class="line">    <span class="keywordflow">return</span> 0.0</div>
</div><!-- fragment --><p>If <code>INIT</code> is not specified, plumed will search for an object "plumedInit", that can be either a function that returns a dict or a dict This dict MUST contain at least the informations about the presence of the derivatives and on the periodicity of the variable. We will refer to this dict as "the init dict" from now.</p>
<p>If <code>CALCULATE</code> is not specified, plumed will search for a function named "plumedCalculate" plumed will read the variable returned accordingly to what it was specified in the initialization dict.</p>
<p>The init dict will tell plumed how many components the calculate function will return and how they shall behave. Along this the dict can contain all the keyword that are compatible with PYCVINTERFACE. Mind that if the same keyword is specified both in the init dict and in the plumed file the calculation will be aborted to avoid unwated settings confict. In case of flags the dict entry must be a bool, differently from the standard plumed input.</p>
<p>The only keyword that can only be specified in python is <code>COMPONENTS</code>. The <code>COMPONENTS</code> key must point to a dict that has as keys the names of the componensts. Each component dictionary must have two keys:</p><ul>
<li><code>"period"</code>: <code>None</code> of a list of two values, min and max (like <code>[0,1]</code> or also strings like <code>["0.5*pi","2*pi"]</code>)</li>
<li><code>"derivative"</code>: <code>True</code> or <code>False</code> If you want to use a single component you can create the <code>"COMPONENTS"</code> dict with as single key, the name will be ignored. In the previous example the key <code>"Value"</code> is used instead of <code>"COMPONENTS"</code>: it is a shorter form for <code>"COMPONENTS":{"any":{...}}</code>. To avoid confusion you cannot specify both <code>"COMPONENTS"</code> and <code>"Value"</code> in the same dict.</li>
</ul>
<p>To speed up the declarations of the components the <code>plumedCommunications</code> module contains a submodule <code>defaults</code> with the default dictionaries already set up:</p><ul>
<li>plumedCommunications.defaults.COMPONENT={"period":None, "derivative":True}</li>
<li>plumedCommunications.defaults.COMPONENT_NODEV={"period":None, "derivative":False}</li>
</ul>
<dl class="section user"><dt>The calculate function</dt><dd></dd></dl>
<p>The calculate funtion must, as all the other functions accept a PLMD.PythonCVInterface object as only input.</p>
<p>The calculate function must either return a float or a tuple or, in the case of multiple components, a dict whose keys are the name of the components, whose elements are either float or tuple.</p>
<p>Plumed will assign automatically assign the result to the CV (to the key named element), if the name of the component is missing the calculation will be interrupted with an error message. If derivatives are disabled it will expect a float(or a double). In case of activated derivatives it will interrupt the calculation if the return value would not be a tuple. The tuple should be (float, ndArray(nat,3),ndArray(3,3)) with the first elements the value, the second the atomic derivatives and the third the box derivative (that can also have shape(9), with format (x_x, x_y, x_z, y_x, y_y, y_z, z_x, z_y, z_z)), if the box derivative are not present a WARNING will be raised, but the calculation won't be interrupted.</p>
<dl class="section user"><dt>The prepare and update functions and the "data" attribute</dt><dd></dd></dl>
<p>If the <code>PREPARE</code> keyword is used, the defined function will be called at prepare time, before calculate. The prepare dictionary can contain a <code>"setAtomRequest"</code> key with a parseable ATOM string, like in the input (or a list of indexes, 0 based). </p><div class="fragment"><div class="line"><span class="comment">#this , with &quot;PREPARE=changeAtom&quot; in the plumed file will select a new atom at each new step</span></div>
<div class="line"><span class="keyword">def </span>changeAtom(plmdAction: plumedCommunications.PythonCVInterface):</div>
<div class="line">    toret = {<span class="stringliteral">&quot;setAtomRequest&quot;</span>: f<span class="stringliteral">&quot;1, {int(plmdAction.getStep()) + 2}&quot;</span>}</div>
<div class="line">    <span class="keywordflow">if</span> plmdAction.getStep() == 3:</div>
<div class="line">        toret[<span class="stringliteral">&quot;setAtomRequest&quot;</span>] = <span class="stringliteral">&quot;1,2&quot;</span></div>
<div class="line">    <span class="keywordflow">return</span> toret</div>
</div><!-- fragment --><p>If the <code>UPDATE</code> keyword is used, the defined function will be called at update time, after calculate. As now plumed will ignore the return of this function (but it stills need to return a dict) and it is intended to accumulate things or post process data afer calculate</p>
<p>In the example <code>plmdAction.data["pycv"]=0</code> is intialized in <code>pyinit</code> and its value is updated in calculate.</p>

<div style="width: 90%; float:left" id="value_details_eg2"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/master-failed-red.svg" alt="tested on master" /></div><pre style="width: 97%;" class="fragment">
<b name="eg2cv1" onclick='showPath("eg2","eg2cv1")'>cv1: </b><a href="https://www.plumed.org/doc-master/user-doc/html/_p_y_c_v_i_n_t_e_r_f_a_c_e.html" style="color:green">PYCVINTERFACE</a> ...
   <div class="tooltip">ATOMS<div class="right"><b> could not find this keyword </b><i></i></div></div>=@mdatoms 
   <div class="tooltip">IMPORT<div class="right"><b> could not find this keyword </b><i></i></div></div>=pycvPersistentData 
   <div class="tooltip">CALCULATE<div class="right"><b> could not find this keyword </b><i></i></div></div>=pydist 
   <div class="tooltip">INIT<div class="right"><b> could not find this keyword </b><i></i></div></div>=pyinit 
...<span style="display:none;" id="eg2cv1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-master/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=colvar.out <div class="tooltip">ARG<div class="right"><b>compulsory keyword </b>
the labels of the values that you would like to print to the file <i></i></div></div>=* <span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<div class="fragment"><div class="line"><span class="keyword">import</span> plumedCommunications <span class="keyword">as</span> PLMD</div>
<div class="line"><span class="keyword">from</span> plumedCommunications.defaults <span class="keyword">import</span> COMPONENT_NODEV</div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>pyinit(plmdAction: PLMD.PythonCVInterface):</div>
<div class="line">    plmdAction.data[<span class="stringliteral">&quot;pycv&quot;</span>]=0</div>
<div class="line">    print(f<span class="stringliteral">&quot;{plmdAction.data=}&quot;</span>, file=log)</div>
<div class="line">    <span class="keywordflow">return</span> {<span class="stringliteral">&quot;Value&quot;</span>:COMPONENT_NODEV}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>pydist(plmdAction: PLMD.PythonCVInterface):</div>
<div class="line">    plmdAction.data[<span class="stringliteral">&quot;pycv&quot;</span>]+=plmdAction.getStep()</div>
<div class="line">    d=plmdAction.data[<span class="stringliteral">&quot;pycv&quot;</span>]</div>
<div class="line">    <span class="keywordflow">return</span> d</div>
</div><!-- fragment --><p>The plumedCommunications.PythonCVInterface has a <code>data</code> attribute that is a dictionary and can be used to store data during the calculations</p>
<dl class="section user"><dt>Getting the manual</dt><dd>You can obtain the manual of the module (and of its components) by running plumed driver with this plumed file 
<div style="width: 90%; float:left" id="value_details_eg3"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/with-LOAD-yellow.svg" alt="tested on master" /></div><pre style="width: 97%;" class="fragment">
<a href="https://www.plumed.org/doc-master/user-doc/html/_l_o_a_d.html" style="color:green">LOAD</a> <div class="tooltip">GLOBAL<div class="right"><b> could not find this keyword </b><i></i></div></div> <div class="tooltip">FILE<div class="right"><b>compulsory keyword </b>
file to be loaded <i></i></div></div>=PythonCVInterface.so <span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3cvdist" onclick='showPath("eg3","eg3cvdist")'>cvdist: </b><a href="https://www.plumed.org/doc-master/user-doc/html/_p_y_c_v_i_n_t_e_r_f_a_c_e.html" style="color:green">PYCVINTERFACE</a> <div class="tooltip">IMPORT<div class="right"><b> could not find this keyword </b><i></i></div></div>=pyhelp <span style="display:none;" id="eg3cvdist"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-master/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=colvar.out <div class="tooltip">ARG<div class="right"><b>compulsory keyword </b>
the labels of the values that you would like to print to the file <i></i></div></div>=* <span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
 and this py module <div class="fragment"><div class="line"><span class="keyword">import</span> plumedCommunications</div>
<div class="line"><span class="keyword">import</span> pydoc</div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>plumedInit(_):</div>
<div class="line">    <span class="keyword">with</span> open(<span class="stringliteral">&#39;PythonCVInterface.help.txt&#39;</span>, <span class="stringliteral">&#39;w&#39;</span>) <span class="keyword">as</span> f:</div>
<div class="line">        h = pydoc.Helper(output=f)</div>
<div class="line">        h(plumedCommunications.PythonCVInterface)</div>
<div class="line">    <span class="keyword">with</span> open(<span class="stringliteral">&#39;plumedCommunications.help.txt&#39;</span>, <span class="stringliteral">&#39;w&#39;</span>) <span class="keyword">as</span> f:</div>
<div class="line">        h = pydoc.Helper(output=f)</div>
<div class="line">        h(plumedCommunications)</div>
<div class="line">    <span class="keyword">with</span> open(<span class="stringliteral">&#39;plumedCommunications.defaults.help.txt&#39;</span>, <span class="stringliteral">&#39;w&#39;</span>) <span class="keyword">as</span> f:</div>
<div class="line">        h = pydoc.Helper(output=f)</div>
<div class="line">        h(plumedCommunications.defaults)</div>
<div class="line">    <span class="keywordflow">return</span> {<span class="stringliteral">&quot;Value&quot;</span>:plumedCommunications.defaults.COMPONENT_NODEV, <span class="stringliteral">&quot;ATOMS&quot;</span>:<span class="stringliteral">&quot;1&quot;</span>}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>plumedCalculate(_):</div>
<div class="line">    <span class="keywordflow">return</span> 0</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>Tips and tricks and examples</dt><dd></dd></dl>
<p>Automatic differentiation and transparent compilation (including to GPU) can be performed via Google's <a href="https://github.com/google/jax">JAX library</a>: see the example below.</p>
<p>The following input tells PLUMED to print the distance between atoms 1 and 4.</p>

<div style="width: 90%; float:left" id="value_details_eg4"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/master-failed-red.svg" alt="tested on master" /></div><pre style="width: 97%;" class="fragment">
<b name="eg4cv1" onclick='showPath("eg4","eg4cv1")'>cv1: </b><a href="https://www.plumed.org/doc-master/user-doc/html/_p_y_t_h_o_n_c_v.html" style="color:green">PYTHONCV</a> <div class="tooltip">ATOMS<div class="right"><b> could not find this keyword </b><i></i></div></div>=1,4 <div class="tooltip">IMPORT<div class="right"><b> could not find this keyword </b><i></i></div></div>=distcv <div class="tooltip">CALCULATE<div class="right"><b> could not find this keyword </b><i></i></div></div>=cv <span style="display:none;" id="eg4cv1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-master/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=colvar.out <div class="tooltip">ARG<div class="right"><b>compulsory keyword </b>
the labels of the values that you would like to print to the file <i></i></div></div>=* <span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>The file <code>distcv.py</code> should contain something as follows.</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div>
<div class="line"><span class="keyword">import</span> plumedCommunications <span class="keyword">as</span> PLMD</div>
<div class="line"> </div>
<div class="line">plumedInit={<span class="stringliteral">&quot;Value&quot;</span>:PLMD.defaults.COMPONENT}</div>
<div class="line"><span class="comment"># Define the distance function</span></div>
<div class="line"><span class="keyword">def </span>dist_f(x):</div>
<div class="line">    r = x[0,:]-x[1,:]</div>
<div class="line">    d2 = np.dot(r,r)</div>
<div class="line">    <span class="keywordflow">return</span> np.sqrt(d2)</div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>grad_dist(x):</div>
<div class="line">    d = dist_f(x)</div>
<div class="line">    r = x[0,:]-x[1,:]</div>
<div class="line">    g = r/d</div>
<div class="line">    <span class="keywordflow">return</span> np.array([g,-g])</div>
<div class="line"> </div>
<div class="line"><span class="comment"># The CV function actually called</span></div>
<div class="line"><span class="keyword">def </span>cv(action:PLMD.PythonCVInterface):</div>
<div class="line">    <span class="keywordflow">return</span> dist_f(action.getPositions()), grad_dist(action.getPositions())</div>
</div><!-- fragment --><dl class="section user"><dt>JAX for automatic differentiation and compilation</dt><dd></dd></dl>
<p>Automatic differentiation and transparent compilation (including to GPU) can be performed via Google's <a href="https://github.com/google/jax">JAX library</a>. In a nutshell, it's sufficient to replace <code>numpy</code> with <code>jax.numpy</code>. See the following example.</p>

<div style="width: 90%; float:left" id="value_details_eg5"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/master-failed-red.svg" alt="tested on master" /></div><pre style="width: 97%;" class="fragment">
<b name="eg5cv1" onclick='showPath("eg5","eg5cv1")'>cv1: </b><a href="https://www.plumed.org/doc-master/user-doc/html/_p_y_t_h_o_n_c_v.html" style="color:green">PYTHONCV</a> <div class="tooltip">ATOMS<div class="right"><b> could not find this keyword </b><i></i></div></div>=1,2,3 <div class="tooltip">IMPORT<div class="right"><b> could not find this keyword </b><i></i></div></div>=jaxcv <div class="tooltip">CALCULATE<div class="right"><b> could not find this keyword </b><i></i></div></div>=angle <span style="display:none;" id="eg5cv1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
PRINT FILE=colvar.out ARG=*<p>And, in <code>jaxcv.py</code>...</p>
<div class="fragment"><div class="line"><span class="comment"># Import the JAX library</span></div>
<div class="line"><span class="keyword">import</span> jax.numpy <span class="keyword">as</span> np</div>
<div class="line"><span class="keyword">from</span> jax <span class="keyword">import</span> grad, jit, vmap</div>
<div class="line"><span class="keyword">import</span> plumedCommunications <span class="keyword">as</span> PLMD</div>
<div class="line"> </div>
<div class="line">plumedInit={<span class="stringliteral">&quot;Value&quot;</span>:PLMD.defaults.COMPONENT}</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Implementation of the angle function</span></div>
<div class="line"><span class="keyword">def </span>angle_f(x):</div>
<div class="line">    r1 = x[0,:]-x[1,:]</div>
<div class="line">    r2 = x[2,:]-x[1,:]</div>
<div class="line"> </div>
<div class="line">    costheta = np.dot(r1,r2) / np.linalg.norm(r1) / np.linalg.norm(r2)</div>
<div class="line">    theta = np.arccos(costheta)</div>
<div class="line">    <span class="keywordflow">return</span> theta</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Use JAX to auto-gradient it</span></div>
<div class="line">angle_grad = grad(angle_f)</div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>cv(action:PLMD.PythonCVInterface):</div>
<div class="line">    <span class="keywordflow">return</span> angle_f(action.getPositions()), angle_grad(action.getPositions())</div>
</div><!-- fragment --><p>There are however <a href="https://github.com/google/jax#current-gotchas">limitations</a>, the most notable of which is that indexed assignments such as <code>x[i]=y</code> are not allowed, and should instead be replaced by functional equivalents such as <code>x=jax.ops.index_update(x, jax.ops.index[i], y)</code>.</p>
<dl class="section user"><dt>Multiple components</dt><dd></dd></dl>
<p>It is possible to return multiple components at a time. This may be useful e.g. if they reuse part of the computation. To do so, pass the declare the <code>"COMPONENTS"</code> key in the init dict, and assign to each key a dict with the same rules of the key <code>"Value"</code>. In this case, the function must return a dict with the component names as keys, see the "calculate" paragraph. Inside PLUMED, component names will be prefixed by <code>py-</code>.</p>
<p>Note that you can use JAX's Jacobian function <code>jax.jacrev()</code> to conveniently compute the gradients all at once (see regtests). For example:</p>

<div style="width: 90%; float:left" id="value_details_eg6"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/master-failed-red.svg" alt="tested on master" /></div><pre style="width: 97%;" class="fragment">
<b name="eg6cv1" onclick='showPath("eg6","eg6cv1")'>cv1: </b><a href="https://www.plumed.org/doc-master/user-doc/html/_p_y_t_h_o_n_c_v.html" style="color:green">PYTHONCV</a> <div class="tooltip">ATOMS<div class="right"><b> could not find this keyword </b><i></i></div></div>=1,3,4 <div class="tooltip">IMPORT<div class="right"><b> could not find this keyword </b><i></i></div></div>=distcv <div class="tooltip">FUNCTION<div class="right"><b> could not find this keyword </b><i></i></div></div>=cv <div class="tooltip">COMPONENTS<div class="right"><b> could not find this keyword </b><i></i></div></div>=d12,d13 <span style="display:none;" id="eg6cv1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<div class="fragment"><div class="line"><span class="keyword">import</span> jax.numpy <span class="keyword">as</span> np</div>
<div class="line"><span class="keyword">from</span> jax <span class="keyword">import</span> jacrev, jit</div>
<div class="line"><span class="keyword">import</span> plumedCommunications <span class="keyword">as</span> PLMD</div>
<div class="line"> </div>
<div class="line">plumedInit = dict(</div>
<div class="line">    COMPONENTS=dict(d12=PLMD.defaults.COMPONENT, d13=PLMD.defaults.COMPONENT)</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Define the distance function</span></div>
<div class="line">@jit</div>
<div class="line"><span class="keyword">def </span>dist_f(X):</div>
<div class="line">    <span class="keywordflow">return</span> {</div>
<div class="line">     <span class="stringliteral">&#39;d12&#39;</span>: np.linalg.norm( X[0,:]-X[1,:] ),</div>
<div class="line">     <span class="stringliteral">&#39;d13&#39;</span>: np.linalg.norm( X[0,:]-X[2,:] )</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">dist_grad=jacrev(dist_f)</div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>cv(action: PLMD.PythonCVInterface):</div>
<div class="line">    toret = {}</div>
<div class="line">    d=dist_f(action.getPositions())</div>
<div class="line">    g=dist_grad(action.getPositions())</div>
<div class="line">    <span class="keywordflow">for</span> key <span class="keywordflow">in</span> [<span class="stringliteral">&quot;d12&quot;</span>,<span class="stringliteral">&quot;d13&quot;</span>]:</div>
<div class="line">        toret[key] = (d[key],g[key])</div>
<div class="line">    <span class="keywordflow">return</span>  toret</div>
</div><!-- fragment --><dl class="section user"><dt>Installation</dt><dd></dd></dl>
<p>A use of an virtual environment or equivalent is recomended. To compile pycv you just need numpy and pybind11, jax is not necessary for compilation and installation.</p>
<p>To compile the shared object library you need also plumed in your path. You need to export the following environmental variables: </p><pre class="fragment">export PLUMED_MKLIB_CFLAGS="$(python3-config --cflags --embed) $(python -m pybind11 --includes)"
export PLUMED_MKLIB_LDFLAGS="$(python3-config --ldflags --embed)"
</pre><p> and then compile the shared object: </p><pre class="fragment">plumed mklib PythonCVInterface.cpp ActionWithPython.cpp PlumedPythonEmbeddedModule.cpp
</pre><p>If you are on linux you can use pycv only with a plumed version that is compatible with the <code>GLOBAL</code> keyword for the action <code>LOAD</code></p>
<dl class="section user"><dt>Glossary of keywords and components</dt><dd></dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
<!--    <li class="navelem"><a class="el" href="colvarintro.html">Collective Variables</a></li><li class="navelem"><a class="el" href="_colvar.html">CV Documentation</a></li>  -->
    <li class="footer">   <!--- Generated by -->
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
