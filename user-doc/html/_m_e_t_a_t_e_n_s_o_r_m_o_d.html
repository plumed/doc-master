<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<title>PLUMED: Metatensor</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script>
   var redpath = "";
   
   function showPath(eg,name) {
     var i; var y = document.getElementsByName(redpath);
     for (i=0; i < y.length; i++ ) { y[i].style.color="black"; }
     var x = document.getElementsByName(name); redpath=name;
     for (i = 0; i < x.length; i++) { x[i].style.color="red"; }
     var valid="value_details_".concat(eg);
     var valueField = document.getElementById(valid);
     var dataField = document.getElementById(name);
     valueField.innerHTML = dataField.innerHTML;
   }
   function swapInput(name) {
     var btn = document.getElementById(name + "_button");
     var mydiv = document.getElementById("input_" + name);
     if( btn.textContent=="expand shortcuts" ) {
         btn.textContent = "contract shortcuts";
         var dataField = document.getElementById(name + "long");
         mydiv.innerHTML = dataField.innerHTML;
     } else if( btn.textContent=="contract shortcuts" ) {
         btn.textContent = "expand shortcuts";
         var dataField = document.getElementById(name + "short");
         mydiv.innerHTML = dataField.innerHTML;
     }
   }
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.11.0-dev</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_m_e_t_a_t_e_n_s_o_r_m_o_d.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Metatensor </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md68"></a>
Overview</h1>
<p>This module implements the interface between PLUMED and <a href="https://docs.metatensor.org/latest/index.html">metatensor</a>, allowing to use arbitrary machine learning models as collective variables. These machine learning models are defined using custom Python code — following the <a href="https://docs.metatensor.org/latest/atomistic/index.html">metatensor atomistic models</a> interface — and then exported to <a href="https://pytorch.org/docs/stable/jit.html">TorchScript</a>. The exported model is then loaded inside PLUMED and executed during the simulation.</p>
<h1><a class="anchor" id="autotoc_md69"></a>
Installation</h1>
<p>This module requires two main dependencies: the C++ torch library (i.e. <code>libtorch</code>); and the C++ metatensor_torch library. There are multiple ways of installing both libraries, which are discussed below.</p>
<h2><a class="anchor" id="autotoc_md70"></a>
Installing the libraries through Python's package manager (&lt;tt&gt;pip&lt;/tt&gt;)</h2>
<p>The easiest way to get all dependencies on your system is to download the pre-built Python wheels with <code>pip</code>. This is the same set of wheels you will need to define custom models.</p>
<div class="fragment"><div class="line">pip install &quot;metatensor-torch ==0.5.5&quot;  # change this version to get newer releases</div>
<div class="line"> </div>
<div class="line"># optional: get the other metatensor tools to define models (these are only usable from Python).</div>
<div class="line">pip install metatensor-operations metatensor-learn</div>
<div class="line"> </div>
<div class="line"># export the location to all the libraries:</div>
<div class="line">TORCH_CMAKE_PREFIX=$(python -c &quot;import torch; print(torch.utils.cmake_prefix_path)&quot;)</div>
<div class="line">TORCH_PREFIX=$(cd &quot;$TORCH_CMAKE_PREFIX/../..&quot; &amp;&amp; pwd)</div>
<div class="line"> </div>
<div class="line">METATENSOR_CMAKE_PREFIX=$(python -c &quot;import metatensor; print(metatensor.utils.cmake_prefix_path)&quot;)</div>
<div class="line">METATENSOR_PREFIX=$(cd &quot;$METATENSOR_CMAKE_PREFIX/../..&quot; &amp;&amp; pwd)</div>
<div class="line"> </div>
<div class="line">METATENSOR_TORCH_CMAKE_PREFIX=$(python -c &quot;import metatensor.torch; print(metatensor.torch.utils.cmake_prefix_path)&quot;)</div>
<div class="line">METATENSOR_TORCH_PREFIX=$(cd &quot;$METATENSOR_TORCH_CMAKE_PREFIX/../..&quot; &amp;&amp; pwd)</div>
<div class="line"> </div>
<div class="line"># The torch library installed by pip uses a pre-cxx11 ABI</div>
<div class="line">TORCH_CPPFLAGS=&quot;-D_GLIBCXX_USE_CXX11_ABI=0&quot;</div>
</div><!-- fragment --><p>That's it, you can now jump to <a href="#building-plumed-with-metatensor">the last part</a> of the installation instructions.</p>
<h2><a class="anchor" id="autotoc_md71"></a>
Using pre-built libraries</h2>
<p>If you only want to use existing models, you can download pre-built versions of the libraries and build PLUMED against these. First, you'll need to download libtorch (see also <a class="el" href="_installation.html#installation-libtorch">LibTorch</a> for other instructions on installing a pre-built libtorch):</p>
<div class="fragment"><div class="line"># Download torch 2.2.2 for x86_64 (Intel) Linux.</div>
<div class="line">#</div>
<div class="line"># Variations of this link for other operating systems (macOS, Windows), CPU</div>
<div class="line"># architecture (Apple Silicon, arm64), CUDA versions, and newer versions of</div>
<div class="line"># libtorch can be found at https://pytorch.org/get-started/locally/</div>
<div class="line"> </div>
<div class="line">wget https://download.pytorch.org/libtorch/cpu/libtorch-cxx11-abi-shared-with-deps-2.2.2%2Bcpu.zip</div>
<div class="line">unzip libtorch-cxx11-abi-shared-with-deps-2.2.2+cpu.zip</div>
<div class="line"> </div>
<div class="line"># alternatively if you have a CUDA-enabled GPU, you can use the corresponding</div>
<div class="line"># pre-built library (here for CUDA 12.1):</div>
<div class="line">wget https://download.pytorch.org/libtorch/cu121/libtorch-cxx11-abi-shared-with-deps-2.2.2%2Bcu121.zip</div>
<div class="line">unzip libtorch-cxx11-abi-shared-with-deps-2.2.2+cu121.zip</div>
<div class="line"> </div>
<div class="line"># Make the location of libtorch visible</div>
<div class="line">TORCH_PREFIX=$(pwd)/libtorch</div>
<div class="line"> </div>
<div class="line"># if you are using a library with pre-cxx11 ABI, you need an extra flag:</div>
<div class="line">TORCH_CPPFLAGS=&quot;-D_GLIBCXX_USE_CXX11_ABI=0&quot;</div>
</div><!-- fragment --><p>Once you acquire libtorch, it is time to build metatensor and metatensor_torch from sources. There is currently no standalone pre-built library for these (although you can use the pre-built version that comes with <code>pip</code>). For this, you'll need a rust compiler on your system, which you can get with <a href="https://rustup.rs/">rustup</a> or any other method at your convenience.</p>
<div class="fragment"><div class="line"># patch a bug from torch&#39;s MKL detection in CMake</div>
<div class="line">cd &lt;PLUMED/DIR&gt;</div>
<div class="line">./src/metatensor/patch-torch.sh &quot;$TORCH_PREFIX&quot;</div>
<div class="line"> </div>
<div class="line">cd &lt;SOME/PLACE/WHERE/TO/PUT/METATENSOR/SOURCES&gt;</div>
<div class="line"> </div>
<div class="line"># define a location where metatensor should be installed</div>
<div class="line">METATENSOR_PREFIX=&lt;...&gt;</div>
<div class="line"> </div>
<div class="line">METATENSOR_TORCH_PREFIX=&quot;$METATENSOR_PREFIX&quot;</div>
<div class="line"> </div>
<div class="line">git clone https://github.com/lab-cosmo/metatensor</div>
<div class="line"># or a more recent release of metatensor-torch</div>
<div class="line">git checkout metatensor-torch-v0.5.5</div>
<div class="line">cd metatensor</div>
<div class="line"> </div>
<div class="line">mkdir build &amp;&amp; cd build</div>
<div class="line">cmake -DBUILD_SHARED_LIBS=ON \</div>
<div class="line">      -DCMAKE_INSTALL_PREFIX=&quot;$METATENSOR_PREFIX&quot; \</div>
<div class="line">      -DCMAKE_PREFIX_PATH=&quot;$TORCH_PREFIX&quot; \</div>
<div class="line">      -DBUILD_METATENSOR_TORCH=ON \</div>
<div class="line">      -DMETATENSOR_INSTALL_BOTH_STATIC_SHARED=OFF \</div>
<div class="line">      ..</div>
<div class="line"> </div>
<div class="line">cmake --build . --target install --parallel</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md72"></a>
Building plumed with metatensor</h2>
<p>Once you installed all dependencies with one of the methods above, you can now configure PLUMED:</p>
<div class="fragment"><div class="line"># set include search path for the compilers</div>
<div class="line">TORCH_INCLUDES=&quot;-I$TORCH_PREFIX/include -I$TORCH_PREFIX/include/torch/csrc/api/include&quot;</div>
<div class="line">CPPFLAGS=&quot;$TORCH_INCLUDES $TORCH_CPPFLAGS -I$METATENSOR_PREFIX/include -I$METATENSOR_TORCH_PREFIX/include $CPPFLAGS&quot;</div>
<div class="line"> </div>
<div class="line"># set library search path for the linker</div>
<div class="line">LDFLAGS=&quot;-L$TORCH_PREFIX/lib -L$METATENSOR_PREFIX/lib -L$METATENSOR_TORCH_PREFIX/lib $LDFLAGS&quot;</div>
<div class="line"> </div>
<div class="line"># set the rpath to make sure plumed executable will be able to find the right libraries</div>
<div class="line">LDFLAGS=&quot;$LDFLAGS -Wl,-rpath,$TORCH_PREFIX/lib&quot;</div>
<div class="line">LDFLAGS=&quot;$LDFLAGS -Wl,-rpath,$METATENSOR_PREFIX/lib -Wl,-rpath,$METATENSOR_TORCH_PREFIX/lib&quot;</div>
<div class="line"> </div>
<div class="line"># If you are running on Linux, force the use of rpath instead of runpath</div>
<div class="line"># (we rely on the rpath to find dependencies of dependencies)</div>
<div class="line">LDFLAGS=&quot;$LDFLAGS -Wl,--disable-new-dtags&quot;</div>
<div class="line"> </div>
<div class="line"># configure PLUMED</div>
<div class="line">./configure --enable-libtorch --enable-metatensor --enable-modules=+metatensor \</div>
<div class="line">    LDFLAGS=&quot;$LDFLAGS&quot; CPPFLAGS=&quot;$CPPFLAGS&quot;</div>
</div><!-- fragment --><p>Pay close attention to the output, it should contain <b>both</b> a line about <code>checking libtorch</code> and a line about <code>checking metatensor</code>, both ending with <code>...yes</code>. If this is not the case, you'll get a warning about <code>cannot enable __PLUMED_HAS_LIBTORCH</code> or <code>cannot enable __PLUMED_HAS_METATENSOR</code>. If you get any of these warnings, you should check <code>config.log</code> to know more about what's going on and why these libraries can't be found.</p>
<h1><a class="anchor" id="autotoc_md73"></a>
Module Contents</h1>
<p>This module defines the following actions:</p>
<table align="center" frame="void" width="95%%" cellpadding="5%%">
<tr>
<td width="5%"><a class="el" href="_m_e_t_a_t_e_n_s_o_r.html">METATENSOR</a>  </td><td>Use arbitrary machine learning models as collective variables.  </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
<!--    <li class="navelem"><a class="el" href="_add_mod.html">Additional Modules</a></li>  -->
    <li class="footer">   <!--- Generated by -->
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
